name: 🚀 Ustalar App Auto Notification

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: 📊 Calculate Progress
      id: progress
      run: |
        # Count files and calculate progress
        TOTAL_FILES=$(find . -name "*.py" -o -name "*.jsx" -o -name "*.js" | wc -l)
        BACKEND_FILES=$(find backend -name "*.py" 2>/dev/null | wc -l || echo 0)
        FRONTEND_FILES=$(find web -name "*.jsx" -o -name "*.js" 2>/dev/null | wc -l || echo 0)
        
        # Calculate progress percentage
        PROGRESS=$(( (BACKEND_FILES + FRONTEND_FILES) * 100 / 50 ))
        if [ $PROGRESS -gt 100 ]; then PROGRESS=100; fi
        
        echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
        echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
        echo "backend_files=$BACKEND_FILES" >> $GITHUB_OUTPUT
        echo "frontend_files=$FRONTEND_FILES" >> $GITHUB_OUTPUT
        
        # Get last commit message
        LAST_COMMIT=$(git log -1 --pretty=format:'%s')
        echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

    - name: 🔔 Send Discord Notification
      if: success()
      run: |
        if [ ! -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "🚀 Ustalar App - Progress Update",
              "description": "Yeni kod push edildi!",
              "color": 65280,
              "fields": [
                {
                  "name": "📊 Progress",
                  "value": "${{ steps.progress.outputs.progress }}%",
                  "inline": true
                },
                {
                  "name": "📁 Total Files", 
                  "value": "${{ steps.progress.outputs.total_files }}",
                  "inline": true
                },
                {
                  "name": "🔄 Last Change",
                  "value": "${{ steps.progress.outputs.last_commit }}",
                  "inline": false
                }
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
            }]
          }' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"
        else
          echo "Discord webhook not configured"
        fi

    - name: 📱 Update Progress JSON
      run: |
        cat > dashboard/progress.json << EOF_JSON
        {
          "project_name": "Ustalar App",
          "last_update": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
          "overall_progress": ${{ steps.progress.outputs.progress }},
          "total_files": ${{ steps.progress.outputs.total_files }},
          "backend_files": ${{ steps.progress.outputs.backend_files }},
          "frontend_files": ${{ steps.progress.outputs.frontend_files }},
          "last_commit": "${{ steps.progress.outputs.last_commit }}",
          "github_url": "https://github.com/${{ github.repository }}"
        }
        EOF_JSON
